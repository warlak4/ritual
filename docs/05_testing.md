# Тестирование «Ритуаль»

## 1. Стратегия тестирования

| Уровень         | Цели                                     | Инструменты                  |
|-----------------|------------------------------------------|------------------------------|
| Unit            | Сервисы NestJS, валидаторы, утилиты      | Jest, ts-jest                |
| Integration     | REST API + БД (контейнер SQL Server)     | supertest, тестовые .env     |
| E2E (UI)        | Критические пользовательские сценарии    | Playwright (headless)        |
| Load            | Массовые операции, транзакции            | k6, сценарии в `tests/load`  |
| Security        | RBAC, SQL injection, CSRF, XSS           | OWASP ZAP baseline, ручные   |
| Backup/Restore  | Целостность и время восстановления       | Сценарии PowerShell + SQLCMD |

## 2. План и артефакты

### 2.1 Unit-тесты
- Локация: `backend/test/unit/*.spec.ts`
- Покрытие:
  - `AuthService` (хэширование, генерация токенов, refresh flow)
  - `OrdersService` (подстановка таблиц, обработка ошибок процедур)
  - `ClientsService` (вызов `sp_upsert_client`, шифрование)
  - Хелперы (форматирование, валидация DTO)
- Запуск: `npm run test`

### 2.2 Интеграционные сценарии
- Локация: `backend/test/e2e/*.spec.ts`
- Использует тестовый контейнер SQL Server, миграции и сиды.
- Покрываемые сценарии:
  1. Создание клиента → заказ → оплата → изменение статуса
  2. Назначение ресурсов церемонии и проверка конфликтов расписания
  3. Проверка ролей (`admin`, `client`, `guest`) на доступ к API
- Запуск: `npm run test:e2e`

### 2.3 UI тесты
- Инструмент Playwright (`frontend/tests/e2e`).
- Сценарии:
  - Авторизация и отображение дашборда (графики, виджеты).
  - Создание клиента, заявки и проверка отображения в списках.
  - Изменение настроек пользователя, проверка сохранения темы/языка.
- Запуск: `npm run test:e2e` (из каталога `frontend`).

### 2.4 Нагрузочное тестирование
- Файлы: `tests/load/orders-load.js`
- Сценарий: 100 виртуальных пользователей создают заявки и платежи (через REST) в течение 5 минут.
- Метрики: p95 latency < 500 мс, error rate < 1%.
- Запуск: `k6 run tests/load/orders-load.js`

### 2.5 Тестирование безопасности
- OWASP ZAP baseline against `http://localhost:3000`.
- Ручные проверки:
  - SQL Injection: передача `1' OR '1'='1` в параметры API → серверные проверки/валидация разрывают запрос.
  - RBAC: попытка клиента получить `/clients/secure` → ожидаем `403`.
  - CSRF: frontend использует `fetch` с токеном; для внешних доменов CORS off; включены security headers (helmet).

### 2.6 Отказоустойчивость и резервное копирование
- Скрипты `db/scripts/07_backup.sql` и `08_restore.sql`.
- План:
  1. Выполнение полного+дифференциального+лог бэкапа.
  2. Удаление тестовых данных → `RESTORE` → верификация (сравнение хэшей таблиц).
- Документирование в `docs/06_operations.md`.

## 3. Покрытие и отчёты

- Покрытие unit: целевой показатель ≥ 70%.
- Отчёт Jest: `coverage/lcov-report/index.html`.
- Отчёт Playwright: `frontend/playwright-report/index.html`.
- Отчёт нагрузочного теста: экспорт JSON из k6 + графики Grafana (по желанию).
- Все артефакты складываются в `docs/reports/`.

## 4. CI/CD (рекомендация)

- Workflow GitHub Actions (пример):
  1. `npm ci` для backend → `npm run lint` → `npm run test`.
  2. `npm ci` для frontend → `npm run lint` → `npm run build`.
  3. Запуск Playwright в headless Chrome.
  4. Сборка докер-образов и публикация в Registry.
- Секреты (JWT, DB) хранятся в GitHub Secrets / Azure Key Vault.

## 5. Таблица трассировки требований

| Требование                         | Тест(ы)                                                                     |
|------------------------------------|-----------------------------------------------------------------------------|
| CRUD заявок + транзакции           | `orders.e2e.spec.ts`, k6 сценарий                                          |
| RBAC (3 роли)                      | `auth-rbac.e2e.spec.ts`                                                    |
| Хранимые процедуры и триггеры      | Unit + интеграционные тесты сервиса + SQL asserts                          |
| Журнал аудита                      | Тест проверяет запись в `audit.audit_log` при изменении заказа             |
| Шифрование данных клиентов         | E2E: создание клиента → выборка через `/clients/secure` vs `/clients`      |
| Резервное копирование              | Скрипт восстановления + проверка целостности                               |
| UI (i18n, тема, хоткеи)            | Playwright сценарии + unit тесты стора настроек                            |

---

Результаты тестов фиксируются в `docs/reports/testing-summary.md` (по итогу прогонов).

